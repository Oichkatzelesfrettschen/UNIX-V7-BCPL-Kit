#!/bin/sh -e

# Make script for bcplkit
cd "$(dirname "$0")"

DIRS="src doc"
MAKE=make

usage()
{
    echo "usage: makeall [all|clean|install|test|bootstrap]" 1>&2
    exit 2
}

# Initialize
if test $# -gt 1; then
    usage
fi
target=$1
if test -z "$1"; then
    target="all"
fi

case "$target" in
    all|clean|install) maketarget="$target" ;;
    test|bootstrap) maketarget="all" ;;
    *) usage ;;
esac

# Configure

os=`uname`
arch=`uname -m`
case "${os}" in
FreeBSD)
    sys="sys_freebsd.s" ;;
Linux)
    if [ "${arch}" = "x86_64" ]; then
        sys="sys_linux64.s"
        bits=64
    else
        sys="sys_linux.s"
        bits=32
    fi
    ;;
*)
    echo "${os}: Not supported" 1>&2
    exit 2
esac
rm -f src/sys.s
ln -s ${sys} src/sys.s
echo "Configured for ${os}"

if [ -z "$bits" ]; then
    [ "${arch}" = "x86_64" ] && bits=64 || bits=32
# Replace an existing regular file with the correct symbolic link
if [ -e src/sys.s ] && [ ! -h src/sys.s ]; then
    echo "Replacing stale sys.s"
    rm -f src/sys.s
fi
if test -e src/sys.s; then
    :
else
    os=`uname`
    arch=`uname -m`
    case "${os}" in
    FreeBSD)
        sys="sys_freebsd.s" ;;
    Linux)
        if [ "${arch}" = "x86_64" ]; then
            sys="sys_linux64.s"
        else
            sys="sys_linux.s"
        fi
        ;;
    *)
        echo "${os}: Not supported" 1>&2
        exit 2
    esac
    ln -s ${sys} src/sys.s
    echo "Configured for ${os}"
fi
export BUILD_BITS=${bits}

# Make
for dir in ${DIRS}
do

    (cd ${dir} && ${MAKE} ${maketarget})

    (cd ${dir} && BUILD_BITS=${bits} ${MAKE} ${target})

done

if [ "$target" = "test" ]; then

    (cd util && ${MAKE} BCPL=../src/bcpl cmpltest)
    (cd util && ./cmpltest > cmpltest.out)
    grep -q '0 FAILURE(S)' util/cmpltest.out || {
        echo "cmpltest failed" 1>&2
        exit 1
    }
fi

if [ "$target" = "bootstrap" ]; then
    tmp=`mktemp -d`
    for f in st cg xg; do
        cp src/$f $tmp/$f
    done
    (cd src && ${MAKE} clean)
    (cd src && ${MAKE})
    for f in st cg xg; do
        cmp $tmp/$f src/$f >/dev/null || {
            echo "$f differs after rebuild" 1>&2
            exit 1
        }
    done
    rm -rf $tmp
fi
